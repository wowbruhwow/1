<!-- SPDX-License-Identifier: LicenseRef-CityLegends-Proprietary-Software -->
# Test Plan — Scope C1 (Smoke E2E + CI + A11y/Visual)

## Objectives
- Підтвердити життєздатність ключового флоу: **Home → Auth → Create Room → Join Room → Play**.
- Давати ранній сигнал регресій у PR через headless E2E в CI з HTML-репортом.
- Виконати базове **A11y-рев’ю** для критичних екранів (**Home/Auth/Lobby**):
  - семантичні заголовки та ролі,
  - керованість з клавіатури (focus),
  - оголошення помилок через `role="alert"` / live-region.
- Додати **візуальні снапшоти** ключових екранів (Home, Auth/Lobby) на базі Playwright для фіксації грубих UI-регресій.

## Out of Scope (C1)
- Реальний бекенд/API, повна регресія, перформанс/безпека, мобайл-емуляція (UI тестується лише на десктопних розширеннях), крос-браузер (окрім Chromium).
- Повний WCAG-аудит (усі критерії), крос-скрін-ридери, повний набір breakpoints.

## Test Strategy (Vector)
- Рівні: unit (поза C1), component (опц.), **e2e (C1)**.
- Джерело правди: **Flask mock** (стабільні шаблони).
- Селектори: **getByRole / getByLabel / getByText**.

### E2E скоуп C1
- **Smoke flow** — `tests/e2e/smoke.spec.ts`  
  - Home → Auth (валідація) → Create Room → Join → Play.
- **A11y smoke** — `tests/e2e/a11y.spec.ts`
  - Home/Auth/Lobby:
    - наявність очікуваних заголовків (`<h1>`), ролей (`link`, `button`, `alert`);
    - базовий keyboard-flow (Tab до основної дії на екрані);
    - живі області для помилок (Auth: `role="alert"` при невдалій валідації).
  - Перевірка контрасту:
    - обчислення коефіцієнта контрасту тексту/кнопок проти фону (helper на базі WCAG 2.1);
    - поріг **≥ 4.5:1** для стандартного тексту, **≥ 3.0:1** — для великих/primary-елементів.
- **Visual snapshots** — `tests/e2e/visual.spec.ts`
  - `Home` — базовий вигляд домашнього екрану.
  - `Auth → Lobby` — стан після успішного логіну.
  - Використовується `expect(page).toHaveScreenshot(...)` з mock-сервером:
    - перший запуск формує еталонні зображення (`home.png`, `lobby.png`);
    - подальші рани порівнюють поточний UI з еталоном.
  - Оновлення снапшотів — лише через код-рев’ю (щоб уникати «легалізації» регресій).

## Scope C2 — Lobby → Play + матч через WS-мок

### Цілі C2

- Зафіксувати й автоматизувати **мінімальний ігровий флоу** після логіну:
  - створення кімнати,
  - приєднання до кімнати,
  - перехід із Lobby до Play Screen,
  - програвання базового демо-матчу через `ws-mock`.
- Перевірити, що FE коректно використовує **HTTP-мок** (`mocks/api/server.py`) та **WS-мок** (`mocks/ws-mock.js`) згідно з контрактами в `docs/dev/api/openapi.yaml` та `docs/dev/api/ws-events.md`.
- Розділити покриття між **Playwright-смоуком** та **ручними тестами**, не лізучи в повний rules-engine.

---

### Сценарії C2

#### 1. Створення кімнати

**Playwright (E2E):**

- Передумови:
  - Запущено HTTP-мок (`mocks/api/server.py`).
  - Користувач залогінений і знаходиться на екрані профілю / лобі (`player-profile.html`).
- Кроки:
  - Відкрити модалку **«Створити кімнату»**.
  - Заповнити мінімально валідні поля:
    - назва кімнати,
    - кількість гравців = 2,
    - режим = «Швидка»,
    - доступ = «Відкрита» (без пароля).
  - Натиснути **підтвердити** → очікується `POST /rooms` з валідним payload.
- Перевірки:
  - Кімната з’являється в *правій панелі* списку кімнат.
  - У правій інформаційній панелі показано **назву**, **ID/код кімнати**, режим, кількість гравців, статус доступу.
  - Є активна кнопка/дія для старту матчу (*наприклад, «Почати гру»*).

**Ручні тести:**

- Валідація граничних значень:
  - порожня назва,
  - надто довга назва,
  - некоректні комбінації опцій (наприклад, приватна кімната без пароля).
- Поведінка UI:
  - стани кнопок (disabled / loading) при створенні,
  - тексти помилок при 400 з бекенду,
  - коректність копірайту / підказок у модалці.

---

#### 2. Приєднання до кімнати

**Playwright (E2E):**

- Передумови:
  - Є хоча б одна **публічна** кімната (можна створити через API або попередній тест).
- Кроки:
  - Відкрити панель **«Знайти кімнату»**.
  - Завантажити список кімнат (`GET /rooms`).
  - Обрати кімнату зі статусом `public` та натиснути **«Приєднатися»** → `POST /rooms/{id}/join`.
- Перевірки:
  - Запит `join` успішний (201/200) та повертає `room`, `playerId`, `wsUrl`.
  - У правій панелі кімнати:
    - відображається **новий гравець** (нік, колір/команда, тощо),
    - оновлюється **лічильник гравців**.
  - Кнопки/контроли, доступні лише host’у, *не активні* у приєднаного гравця.

**Ручні тести:**

- Приєднання до **приватної** кімнати:
  - модалка з полем для пароля,
  - помилка «Невірний пароль кімнати.» при 403 з `/rooms/{id}/join`.
- Поведінка при:
  - кімнаті, що вже заповнена,
  - кімнаті, яку видалили/закрили (404),
  - порожньому списку кімнат (empty state в правій панелі).

---

#### 3. Перехід із Lobby до Play Screen

**Playwright (E2E):**

- Передумови:
  - Успішне `join` (див. попередній сценарій), отримано валідний `wsUrl`.
- Кроки (хеппі-паси):
  - Ініціювати старт матчу з лобі (кнопка host’а).
  - Дочекатися переходу:
    - Lobby → **екран завантаження** (`/load` / індикатор прогресу),
    - далі до **вікна гри** (`playable-window.html` / `/play/:matchId`).
- Перевірки:
  - На екрані завантаження є прогрес-бар і він закінчується переходом у Play.
  - У Play Screen:
    - відображаються правильно **обидва гравці**,
    - в шапці показано **таймер ходу** та індикатор активного гравця,
    - немає «висячих» елементів лобі (зайвих панелей, кнопок з попереднього екрану).

**Ручні тести:**

- Натискання кнопки «Назад у профіль» / повернення з Play до лобі.
- Поведінка при:
  - перезавантаженні сторінки на екрані Play,
  - таймінгах завантаження (дуже швидка / дуже повільна відповідь),
  - розриві зв’язку до завершення завантаження.

---

#### 4. Базові події матчу (через WS-мок)

Основою є сценарій з `docs/dev/api/ws-events.md`:  
`match_start → turn_start (you) → move_committed → turn_start (opponent) → afk_warning → technical_loss`.

**Playwright (E2E, інтеграція з `ws-mock`):**

- Передумови:
  - Запущено WS-мок (`node mocks/ws-mock.js`).
  - Клієнт підключається до `wsUrl`, що повернув `/rooms/{id}/join`.
- Перевірка ключових подій:

  1. `match_start`
     - Вікно гри переходить у «ігровий» стан (дошка, рука, HUD).
     - Показано список гравців, де позначено **«ти»** (наприклад, `isYou` / візуальний бейдж).

  2. `turn_start` (хід поточного клієнта)
     - Відображається статус **«Ваш хід»**.
     - Основні ігрові дії доступні (нема disabled-стану на кнопках/картах гравця).

  3. `move_committed`
     - З’являється запис у **лозі/чаті** з коротким описом дії (`summary`).
     - Відповідні елементи UI оновлюються (наприклад, зміни HP/VP або стану дошки — на рівні того, що вже реалізовано у FE).

  4. `turn_start` (опонент)
     - Статус змінюється на **«Хід суперника»**.
     - Основні дії гравця вимкнено (disabled / aria-disabled).

  5. `afk_warning` → `technical_loss`
     - Показується попередження, що опонент AFK.
     - Після `technical_loss` відображається **екран перемоги** / банер з причиною (виграш по технічній поразці).
     - Є можливість повернутися до лобі (кнопка «Повернутися до лобі» або аналог).

**Ручні тести:**

- Візуальні деталі:
  - анімації таймера,
  - оформлення повідомлень/тостів,
  - коректність текстів у чатику / логах.
- Додаткові варіації WS-подій (якщо будуть додані пізніше):
  - повторні `turn_start`,
  - декілька `move_committed` поспіль,
  - довший ланцюжок ходів.

---

### Out of Scope (C2)

У цьому скопі **свідомо не перевіряємо**:

- **Повний rules-engine матчу**
  - коректність усіх карт, ефектів, комбо, балансу,
  - складні послідовності ходів, підрахунок очок, кінець гри за всіма умовами.
- **Перформанс і навантаження**
  - latency WS-повідомлень, time-to-first-move,
  - стабільність при великій кількості паралельних матчів,
  - довгі сесії / витік пам’яті.
- **Мульти-клієнтний сценарій 3–4 гравців** (поза базовою демо-послідовністю 1-на-1).
- **Повний responsive / mobile** для екранів Play/Lobby (далі тільки десктопні ширини як у C1).

---

### Підсумкова таблиця покриття C2

| Сценарій                                           | Playwright | Ручні тести |
| -------------------------------------------------- | ---------- | ----------- |
| Створення кімнати (хеппі-пасс)                     | ✅         | ✅ (edge-кейси/UX) |
| Приєднання до публічної кімнати                    | ✅         | ✅ (private/помилки) |
| Lobby → Load → Play Screen                         | ✅         | ✅ (reconnect/«назад») |
| Базова послідовність WS-подій матчу (demo script)  | ✅         | ✅ (візуал/extra flow) |
| Повний rules-engine / перформанс / 3–4 гравці      | ❌         | ❌ (out of scope C2) |

## Metrics & Reporting
- Pass rate C1-smoke; середній час ран-у.
- Flaky index (fail → pass on retry).
- A11y-smoke:
  - кількість падінь через порушення контрасту / відсутній фокус / відсутній alert/live-region.
- Visual-regression:
  - кількість змін базових снапшотів/місяць (має бути невелика та пояснювана змінами дизайну).
- Артефакти: HTML-репорт, трейси/відео (на first retry), PNG-снапшоти ключових екранів.

## Ownership & SLAs
- **QA**: власник плану/сценаріїв, підтримка A11y/visual покриття.
- **Dev**: фікс смоук-блокерів ≤ 24h; участь у виправленні A11y/visual дефектів.
- **CI maintainer**: стабільність пайплайну, версії Node/Python/Playwright.

## Beyond C1 (Roadmap)
- **C2**: staging API + critical negative, розширення A11y-перевірок (рольові лендмарки, навігація, responsive для десктопних ширин, без мобайл-емуляції).
- **C3**: cross-browser, поглиблений accessibility audit, perf smoke, розширена візуальна регресія (інші екрани/стани).
